# åç«¯éƒ¨ç½²æŒ‡å— - å®‰å…¨ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

å‰ç«¯å·²å®ŒæˆDockeråŒ–éƒ¨ç½²ï¼Œä½¿ç”¨Nginxåå‘ä»£ç†+SSLè¯ä¹¦ï¼Œè¿è¡Œåœ¨ `https://duhaosecurity.com`ã€‚
åç«¯éœ€è¦éƒ¨ç½²åˆ°åŒä¸€æœåŠ¡å™¨ï¼Œé€šè¿‡APIè·¯å¾„æä¾›æœåŠ¡ã€‚

## å½“å‰åŸºç¡€è®¾æ–½çŠ¶æ€

### âœ… å·²å®Œæˆçš„åŸºç¡€è®¾æ–½
- **æœåŠ¡å™¨**ï¼šè…¾è®¯äº‘UbuntuæœåŠ¡å™¨ (IP: 62.234.150.58)
- **åŸŸåè§£æ**ï¼šduhaosecurity.com â†’ æœåŠ¡å™¨IP
- **SSLè¯ä¹¦**ï¼šLet's Encryptè‡ªåŠ¨ç»­æœŸè¯ä¹¦
- **å‰ç«¯åº”ç”¨**ï¼šDockerå®¹å™¨è¿è¡Œåœ¨3000ç«¯å£
- **Nginxåå‘ä»£ç†**ï¼šå·²é…ç½®å‰åç«¯è·¯ç”±è§„åˆ™
- **Dockeré•œåƒåŠ é€Ÿ**ï¼šå·²é…ç½®å›½å†…é•œåƒæº

### ğŸ”§ Nginxè·¯ç”±é…ç½®ï¼ˆå·²ç”Ÿæ•ˆï¼‰
```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name duhaosecurity.com www.duhaosecurity.com;
    
    # SSLè¯ä¹¦ï¼ˆcertbotè‡ªåŠ¨ç®¡ç†ï¼‰
    ssl_certificate /etc/letsencrypt/live/duhaosecurity.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/duhaosecurity.com/privkey.pem;
    
    # å‰ç«¯åº”ç”¨
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # åç«¯APIï¼ˆç­‰å¾…åç«¯éƒ¨ç½²ï¼‰
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## åç«¯å·¥ç¨‹å¸ˆéƒ¨ç½²ä»»åŠ¡

### 1. å‡†å¤‡å·¥ä½œ

#### 1.1 æœåŠ¡å™¨è®¿é—®
```bash
# SSHè¿æ¥æœåŠ¡å™¨
ssh ubuntu@62.234.150.58

# ç¡®è®¤Dockerç¯å¢ƒ
sudo docker --version
sudo docker ps  # åº”è¯¥çœ‹åˆ° checkin-frontend å®¹å™¨åœ¨è¿è¡Œ
```

#### 1.2 ç¡®è®¤ç«¯å£å¯ç”¨æ€§
```bash
# æ£€æŸ¥8080ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo netstat -tlnp | grep 8080
# å¦‚æœæ— è¾“å‡ºï¼Œè¯´æ˜ç«¯å£å¯ç”¨
```

### 2. Dockeréƒ¨ç½²ç­–ç•¥

#### 2.2 æ„å»ºå’Œè¿è¡Œå‘½ä»¤

```bash
# æ„å»ºåç«¯é•œåƒ
sudo docker build -t checkin-backend:latest .

# è¿è¡Œåç«¯å®¹å™¨ï¼ˆæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ç¯å¢ƒå˜é‡ï¼‰
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_HOST=ä½ çš„æ•°æ®åº“åœ°å€ \
  -e DB_PORT=3306 \
  -e DB_NAME=checkin_db \
  -e DB_USERNAME=æ•°æ®åº“ç”¨æˆ·å \
  -e DB_PASSWORD=æ•°æ®åº“å¯†ç  \
  -e CORS_ORIGIN=https://duhaosecurity.com \
  -e JWT_SECRET=ä½ çš„JWTå¯†é’¥ \
  -e TZ=Asia/Shanghai \
  checkin-backend:latest
```

### 3. ç¯å¢ƒå˜é‡é…ç½®è¦æ±‚

#### 3.1 å¿…éœ€çš„ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“é…ç½®
DB_HOST=æ•°æ®åº“æœåŠ¡å™¨åœ°å€
DB_PORT=æ•°æ®åº“ç«¯å£
DB_NAME=æ•°æ®åº“åç§°
DB_USERNAME=æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD=æ•°æ®åº“å¯†ç 

# åº”ç”¨é…ç½®
SPRING_PROFILES_ACTIVE=prod  # æˆ–ç›¸åº”çš„ç”Ÿäº§ç¯å¢ƒé…ç½®
CORS_ORIGIN=https://duhaosecurity.com  # é‡è¦ï¼šCORSé…ç½®
JWT_SECRET=å®‰å…¨çš„JWTå¯†é’¥

# ç³»ç»Ÿé…ç½®
TZ=Asia/Shanghai
```

#### 3.2 CORSé…ç½®é‡è¦è¯´æ˜
åç«¯å¿…é¡»é…ç½®CORSå…è®¸æ¥è‡ª `https://duhaosecurity.com` çš„è¯·æ±‚ï¼š

```java
// Spring Bootç¤ºä¾‹
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("https://duhaosecurity.com")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}
```

### 4. APIè·¯å¾„è®¾è®¡

#### 4.1 APIåŸºç¡€è·¯å¾„
- **å‰ç«¯è®¿é—®åœ°å€**ï¼š`https://duhaosecurity.com/api/`
- **å®¹å™¨å†…éƒ¨åœ°å€**ï¼š`http://localhost:8080/`
- **è·¯å¾„æ˜ å°„**ï¼š`/api/*` â†’ `http://localhost:8080/*`

#### 4.2 æ¨èçš„APIç«¯ç‚¹ç»“æ„
```
https://duhaosecurity.com/api/health          â†’ å¥åº·æ£€æŸ¥
https://duhaosecurity.com/api/auth/login      â†’ ç”¨æˆ·ç™»å½•
https://duhaosecurity.com/api/auth/logout     â†’ ç”¨æˆ·ç™»å‡º
https://duhaosecurity.com/api/guards          â†’ ä¿å®‰ç®¡ç†
https://duhaosecurity.com/api/sites           â†’ ç«™ç‚¹ç®¡ç†
https://duhaosecurity.com/api/checkins        â†’ ç­¾åˆ°è®°å½•
https://duhaosecurity.com/api/dashboard       â†’ ä»ªè¡¨æ¿æ•°æ®
```

### 5. æ•°æ®åº“é…ç½®

#### 5.1 æ•°æ®åº“æœåŠ¡å™¨é€‰æ‹©
æ¨èä½¿ç”¨ä»¥ä¸‹æ•°æ®åº“æ–¹æ¡ˆä¹‹ä¸€ï¼š
- **Docker MySQLå®¹å™¨**ï¼šæˆæœ¬ä½ï¼Œéœ€è¦æ‰‹åŠ¨å¤‡ä»½

#### 5.2 Docker MySQLéƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
å¦‚æœé€‰æ‹©Dockeréƒ¨ç½²æ•°æ®åº“ï¼š

```bash
# åˆ›å»ºMySQLå®¹å™¨
sudo docker run -d \
  --name checkin-mysql \
  --restart always \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=å¼ºå¯†ç  \
  -e MYSQL_DATABASE=checkin_db \
  -e MYSQL_USER=checkin_user \
  -e MYSQL_PASSWORD=ç”¨æˆ·å¯†ç  \
  -v /opt/mysql/data:/var/lib/mysql \
  -e TZ=Asia/Shanghai \
  mysql:8.0

# é…ç½®æ•°æ®åº“è¿æ¥
DB_HOST=localhost
DB_PORT=3306
DB_NAME=checkin_db
DB_USERNAME=checkin_user
DB_PASSWORD=ç”¨æˆ·å¯†ç 
```

### 6. éƒ¨ç½²éªŒè¯æ­¥éª¤

#### 6.1 åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
sudo docker ps
# åº”è¯¥çœ‹åˆ° checkin-backend å®¹å™¨çŠ¶æ€ä¸º Up

# 2. æ£€æŸ¥å®¹å™¨æ—¥å¿—
sudo docker logs checkin-backend
# åº”è¯¥çœ‹åˆ°åº”ç”¨æ­£å¸¸å¯åŠ¨æ—¥å¿—

# 3. æµ‹è¯•å¥åº·æ£€æŸ¥
curl -I http://localhost:8080/health
# åº”è¯¥è¿”å› 200 çŠ¶æ€ç 

# 4. æµ‹è¯•é€šè¿‡Nginxä»£ç†è®¿é—®
curl -I https://duhaosecurity.com/api/health
# åº”è¯¥è¿”å› 200 çŠ¶æ€ç 
```

#### 6.2 APIåŠŸèƒ½æµ‹è¯•
```bash
# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST https://duhaosecurity.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# æµ‹è¯•å…¶ä»–APIç«¯ç‚¹
curl https://duhaosecurity.com/api/guards
curl https://duhaosecurity.com/api/sites
```

### 7. è¿ç»´å’Œç›‘æ§

#### 7.1 æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹åç«¯åº”ç”¨æ—¥å¿—
sudo docker logs -f checkin-backend

# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

#### 7.2 å®¹å™¨ç®¡ç†å‘½ä»¤
```bash
# é‡å¯åç«¯å®¹å™¨
sudo docker restart checkin-backend

# åœæ­¢å®¹å™¨
sudo docker stop checkin-backend

# åˆ é™¤å®¹å™¨ï¼ˆæ³¨æ„æ•°æ®å¤‡ä»½ï¼‰
sudo docker rm checkin-backend

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
sudo docker stats checkin-backend
```

#### 7.3 æ›´æ–°éƒ¨ç½²
```bash
# æ›´æ–°åç«¯åº”ç”¨çš„æ ‡å‡†æµç¨‹
sudo docker stop checkin-backend
sudo docker rm checkin-backend
sudo docker build -t checkin-backend:latest .
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  -p 8080:8080 \
  [ç¯å¢ƒå˜é‡é…ç½®] \
  checkin-backend:latest
```

### 8. å®‰å…¨æ³¨æ„äº‹é¡¹

#### 8.1 ç¯å¢ƒå˜é‡å®‰å…¨
- ä¸è¦åœ¨Dockerfileä¸­å†™å…¥æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨å¤–éƒ¨æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ä¼ é€’å¯†é’¥
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºå¯†ç 

#### 8.2 ç½‘ç»œå®‰å…¨
- æ•°æ®åº“ç«¯å£ä¸å¯¹å¤–æš´éœ²ï¼ˆå¦‚æœä½¿ç”¨Dockerç½‘ç»œï¼‰
- APIæ¥å£å®ç°é€‚å½“çš„è®¤è¯å’Œæˆæƒ
- é…ç½®é€‚å½“çš„è¯·æ±‚é¢‘ç‡é™åˆ¶

#### 8.3 æ•°æ®å®‰å…¨
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- ä½¿ç”¨HTTPSä¼ è¾“æ•æ„Ÿæ•°æ®
- æ—¥å¿—ä¸­ä¸è®°å½•æ•æ„Ÿä¿¡æ¯

### 9. æ•…éšœæ’æŸ¥

#### 9.1 å¸¸è§é—®é¢˜
1. **å®¹å™¨å¯åŠ¨å¤±è´¥**
   ```bash
   sudo docker logs checkin-backend
   # æŸ¥çœ‹å¯åŠ¨é”™è¯¯ä¿¡æ¯
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥å‚æ•°
   - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§

3. **APIè®¿é—®404**
   ```bash
   # æµ‹è¯•å®¹å™¨ç›´æ¥è®¿é—®
   curl http://localhost:8080/health
   # æµ‹è¯•Nginxä»£ç†
   curl https://duhaosecurity.com/api/health
   ```

4. **CORSé”™è¯¯**
   - ç¡®è®¤åç«¯CORSé…ç½®
   - æ£€æŸ¥è¯·æ±‚å¤´è®¾ç½®

#### 9.2 æ€§èƒ½è°ƒä¼˜
```bash
# ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨
sudo docker stats checkin-backend

# å¦‚æœéœ€è¦é™åˆ¶èµ„æºä½¿ç”¨
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  --memory="512m" \
  --cpus="1.0" \
  -p 8080:8080 \
  checkin-backend:latest
```

## è”ç³»ä¿¡æ¯

å¦‚æœ‰éƒ¨ç½²é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **å‰ç«¯è´Ÿè´£äºº**ï¼š[è”ç³»æ–¹å¼]
- **è¿ç»´æ”¯æŒ**ï¼š[è”ç³»æ–¹å¼]

éƒ¨ç½²å®Œæˆåï¼Œæ•´ä¸ªç³»ç»Ÿå°†é€šè¿‡ `https://duhaosecurity.com` æä¾›æœåŠ¡ï¼Œå‰åç«¯å®Œå…¨é›†æˆã€‚