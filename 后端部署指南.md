# 后端部署指南 - 安全签到管理系统

## 项目概述

前端已完成Docker化部署，使用Nginx反向代理+SSL证书，运行在 `https://duhaosecurity.com`。
后端需要部署到同一服务器，通过API路径提供服务。

## 当前基础设施状态

### ✅ 已完成的基础设施
- **服务器**：腾讯云Ubuntu服务器 (IP: 62.234.150.58)
- **域名解析**：duhaosecurity.com → 服务器IP
- **SSL证书**：Let's Encrypt自动续期证书
- **前端应用**：Docker容器运行在3000端口
- **Nginx反向代理**：已配置前后端路由规则
- **Docker镜像加速**：已配置国内镜像源

### 🔧 Nginx路由配置（已生效）
```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name duhaosecurity.com www.duhaosecurity.com;
    
    # SSL证书（certbot自动管理）
    ssl_certificate /etc/letsencrypt/live/duhaosecurity.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/duhaosecurity.com/privkey.pem;
    
    # 前端应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 后端API（等待后端部署）
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 后端工程师部署任务

### 1. 准备工作

#### 1.1 服务器访问
```bash
# SSH连接服务器
ssh ubuntu@62.234.150.58

# 确认Docker环境
sudo docker --version
sudo docker ps  # 应该看到 checkin-frontend 容器在运行
```

#### 1.2 确认端口可用性
```bash
# 检查8080端口是否被占用
sudo netstat -tlnp | grep 8080
# 如果无输出，说明端口可用
```

### 2. Docker部署策略

#### 2.2 构建和运行命令

```bash
# 构建后端镜像
sudo docker build -t checkin-backend:latest .

# 运行后端容器（根据实际需求调整环境变量）
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_HOST=你的数据库地址 \
  -e DB_PORT=3306 \
  -e DB_NAME=checkin_db \
  -e DB_USERNAME=数据库用户名 \
  -e DB_PASSWORD=数据库密码 \
  -e CORS_ORIGIN=https://duhaosecurity.com \
  -e JWT_SECRET=你的JWT密钥 \
  -e TZ=Asia/Shanghai \
  checkin-backend:latest
```

### 3. 环境变量配置要求

#### 3.1 必需的环境变量
```bash
# 数据库配置
DB_HOST=数据库服务器地址
DB_PORT=数据库端口
DB_NAME=数据库名称
DB_USERNAME=数据库用户名
DB_PASSWORD=数据库密码

# 应用配置
SPRING_PROFILES_ACTIVE=prod  # 或相应的生产环境配置
CORS_ORIGIN=https://duhaosecurity.com  # 重要：CORS配置
JWT_SECRET=安全的JWT密钥

# 系统配置
TZ=Asia/Shanghai
```

#### 3.2 CORS配置重要说明
后端必须配置CORS允许来自 `https://duhaosecurity.com` 的请求：

```java
// Spring Boot示例
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("https://duhaosecurity.com")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}
```

### 4. API路径设计

#### 4.1 API基础路径
- **前端访问地址**：`https://duhaosecurity.com/api/`
- **容器内部地址**：`http://localhost:8080/`
- **路径映射**：`/api/*` → `http://localhost:8080/*`

#### 4.2 推荐的API端点结构
```
https://duhaosecurity.com/api/health          → 健康检查
https://duhaosecurity.com/api/auth/login      → 用户登录
https://duhaosecurity.com/api/auth/logout     → 用户登出
https://duhaosecurity.com/api/guards          → 保安管理
https://duhaosecurity.com/api/sites           → 站点管理
https://duhaosecurity.com/api/checkins        → 签到记录
https://duhaosecurity.com/api/dashboard       → 仪表板数据
```

### 5. 数据库配置

#### 5.1 数据库服务器选择
推荐使用以下数据库方案之一：
- **Docker MySQL容器**：成本低，需要手动备份

#### 5.2 Docker MySQL部署（可选）
如果选择Docker部署数据库：

```bash
# 创建MySQL容器
sudo docker run -d \
  --name checkin-mysql \
  --restart always \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=强密码 \
  -e MYSQL_DATABASE=checkin_db \
  -e MYSQL_USER=checkin_user \
  -e MYSQL_PASSWORD=用户密码 \
  -v /opt/mysql/data:/var/lib/mysql \
  -e TZ=Asia/Shanghai \
  mysql:8.0

# 配置数据库连接
DB_HOST=localhost
DB_PORT=3306
DB_NAME=checkin_db
DB_USERNAME=checkin_user
DB_PASSWORD=用户密码
```

### 6. 部署验证步骤

#### 6.1 基础功能测试
```bash
# 1. 检查容器状态
sudo docker ps
# 应该看到 checkin-backend 容器状态为 Up

# 2. 检查容器日志
sudo docker logs checkin-backend
# 应该看到应用正常启动日志

# 3. 测试健康检查
curl -I http://localhost:8080/health
# 应该返回 200 状态码

# 4. 测试通过Nginx代理访问
curl -I https://duhaosecurity.com/api/health
# 应该返回 200 状态码
```

#### 6.2 API功能测试
```bash
# 测试登录接口
curl -X POST https://duhaosecurity.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# 测试其他API端点
curl https://duhaosecurity.com/api/guards
curl https://duhaosecurity.com/api/sites
```

### 7. 运维和监控

#### 7.1 日志管理
```bash
# 查看后端应用日志
sudo docker logs -f checkin-backend

# 查看Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

#### 7.2 容器管理命令
```bash
# 重启后端容器
sudo docker restart checkin-backend

# 停止容器
sudo docker stop checkin-backend

# 删除容器（注意数据备份）
sudo docker rm checkin-backend

# 查看容器资源使用情况
sudo docker stats checkin-backend
```

#### 7.3 更新部署
```bash
# 更新后端应用的标准流程
sudo docker stop checkin-backend
sudo docker rm checkin-backend
sudo docker build -t checkin-backend:latest .
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  -p 8080:8080 \
  [环境变量配置] \
  checkin-backend:latest
```

### 8. 安全注意事项

#### 8.1 环境变量安全
- 不要在Dockerfile中写入敏感信息
- 使用外部文件或环境变量传递密钥
- 生产环境使用强密码

#### 8.2 网络安全
- 数据库端口不对外暴露（如果使用Docker网络）
- API接口实现适当的认证和授权
- 配置适当的请求频率限制

#### 8.3 数据安全
- 定期备份数据库
- 使用HTTPS传输敏感数据
- 日志中不记录敏感信息

### 9. 故障排查

#### 9.1 常见问题
1. **容器启动失败**
   ```bash
   sudo docker logs checkin-backend
   # 查看启动错误信息
   ```

2. **数据库连接失败**
   - 检查数据库服务状态
   - 验证连接参数
   - 检查网络连通性

3. **API访问404**
   ```bash
   # 测试容器直接访问
   curl http://localhost:8080/health
   # 测试Nginx代理
   curl https://duhaosecurity.com/api/health
   ```

4. **CORS错误**
   - 确认后端CORS配置
   - 检查请求头设置

#### 9.2 性能调优
```bash
# 监控容器资源使用
sudo docker stats checkin-backend

# 如果需要限制资源使用
sudo docker run -d \
  --name checkin-backend \
  --restart always \
  --memory="512m" \
  --cpus="1.0" \
  -p 8080:8080 \
  checkin-backend:latest
```

## 联系信息

如有部署问题，请联系：
- **前端负责人**：[联系方式]
- **运维支持**：[联系方式]

部署完成后，整个系统将通过 `https://duhaosecurity.com` 提供服务，前后端完全集成。