# 简单部署说明

## 项目结构

经过清理和优化，现在的部署文件结构非常简洁：

### 核心文件
- **`Dockerfile`** - 前端镜像构建配置
- **`nginx.conf`** - 容器内nginx配置（只serve静态文件）
- **`docker-compose.yml`** - Docker Compose配置（可选使用）
- **`.dockerignore`** - Docker构建忽略文件

### 文档文件
- **`部署说明.md`** - 中文部署说明（本文件）
- **`SIMPLE-DEPLOY.md`** - 英文部署指南

### ✅ 本地测试结果

在本地环境下已通过完整测试：
- ✅ Docker镜像构建成功
- ✅ 容器正常启动（端口3001）
- ✅ HTTP访问正常返回200
- ✅ React Router路由正确工作
- ✅ 安全头正确配置

## 部署架构

```
用户浏览器
    ↓
服务器Nginx（80/443端口）
    ├── / → 前端容器（3001端口）
    └── /api → 后端容器（8080端口）
```

## 本地测试（推荐先测试）

### 1. 构建前端镜像
```bash
# 构建镜像
docker build -t checkin-frontend:latest .
```

### 2. 本地运行测试
```bash
# 方式一：直接运行Docker
docker run -d \
  --name checkin-frontend \
  --restart always \
  -p 3001:80 \
  checkin-frontend:latest

# 方式二：使用docker-compose（推荐）
docker-compose up -d
```

### 3. 本地验证
```bash
# 测试首页
curl -I http://localhost:3001

# 测试路由
curl -I http://localhost:3001/admin

# 查看容器状态
docker ps | grep checkin-frontend

# 查看日志
docker logs checkin-frontend
```

## 云服务器部署步骤

### 1. 上传项目到服务器
```bash
# 方式一：上传项目文件
scp -r . user@your-server-ip:/opt/checkin-frontend/

# 方式二：直接在服务器clone
git clone https://github.com/yourusername/checkin-frontend.git
cd checkin-frontend
```

### 2. 在服务器构建运行前端
```bash
# 构建镜像
docker build -t checkin-frontend:latest .

# 运行容器
docker run -d \
  --name checkin-frontend \
  --restart always \
  -p 3001:80 \
  checkin-frontend:latest
```

### 3. 运行后端容器
```bash
# 运行后端（需要先有后端镜像）
docker run -d \
  --name checkin-backend \
  --restart always \
  -p 8080:8080 \
  -e DB_HOST=数据库地址 \
  -e CORS_ORIGIN=https://your-domain.com \
  checkin-backend:latest
```

### 4. 配置服务器Nginx
```bash
# 安装nginx
sudo apt update && sudo apt install nginx

# 创建配置文件
sudo nano /etc/nginx/sites-available/checkin
```

配置内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端
    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/checkin /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. 配置SSL
```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com
```

## 验证部署

```bash
# 检查容器运行状态
docker ps

# 测试前端
curl http://localhost:3001

# 测试后端
curl http://localhost:8080/api/health

# 测试完整路径
curl https://your-domain.com
curl https://your-domain.com/api/health
```

## 常用命令

```bash
# 查看日志
docker logs checkin-frontend
docker logs checkin-backend

# 重启容器
docker restart checkin-frontend
docker restart checkin-backend

# 更新前端
docker stop checkin-frontend
docker rm checkin-frontend
docker build -t checkin-frontend:latest .
docker run -d --name checkin-frontend --restart always -p 3001:80 checkin-frontend:latest
```

## 注意事项

1. **CORS配置**：后端需要允许来自你域名的请求
2. **API地址**：前端打包时需要正确的API地址
3. **端口冲突**：确保3001和8080端口没有被占用