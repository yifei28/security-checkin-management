name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  # CIé˜¶æ®µï¼šæµ‹è¯•å’Œæ„å»º
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test & Build
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: npm ci

    - name: Lint code
      run: npm run lint

    - name: TypeScript compilation and build
      run: npm run build

    - name: Build Docker image
      run: |
        docker build -t checkin-frontend:latest .
        echo "âœ… Docker image built successfully"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: dist/

  # CDé˜¶æ®µï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        command_timeout: 20m
        script: |
          # è®¾ç½®é¡¹ç›®ç›®å½•è·¯å¾„
          PROJECT_DIR="$HOME/security-checkin-management"

          # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…‹éš†
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ğŸ”„ Repository not found, cloning..."
            git clone https://github.com/yifei28/security-checkin-management.git "$PROJECT_DIR"
          fi

          # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
          cd "$PROJECT_DIR"

          # é…ç½®Gitå®‰å…¨ç›®å½•ï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
          git config --global --add safe.directory "$PROJECT_DIR"

          # æ£€æŸ¥deploy.shæ˜¯å¦å­˜åœ¨
          if [ ! -f "./deploy.sh" ]; then
            echo "âŒ deploy.sh not found in repository"
            echo "ğŸ“ Current directory contents:"
            ls -la
            exit 1
          fi

          # ä½¿ç”¨éƒ¨ç½²è„šæœ¬è¿›è¡Œéƒ¨ç½²ï¼ˆdeploy.sh ä¼šå¤„ç†ä»£ç æ›´æ–°ï¼‰
          chmod +x deploy.sh
          ./deploy.sh --update --clean

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ Frontend deployment to production succeeded!"
        else
          echo "ğŸ’¥ Frontend deployment failed!"
        fi

  # é€šçŸ¥é˜¶æ®µ
  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify
    needs: [test, deploy]
    if: always()

    steps:
    - name: Notification
      run: |
        echo "Frontend Pipeline completed:"
        echo "Test status: ${{ needs.test.result }}"
        echo "Deploy status: ${{ needs.deploy.result }}"